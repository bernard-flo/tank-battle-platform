<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech.  - 6v6 Team Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #a0a0a0;
        }

        .setup-screen {
            display: block;
        }

        .battle-screen {
            display: none;
        }

        .setup-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .team-setup {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .team-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            gap: 15px; /* 아이콘과 입력창 사이 간격 */
        }

        .team-red .team-header {
            background: linear-gradient(135deg, #ff4757, #ff3742);
        }

        .team-blue .team-header {
            background: linear-gradient(135deg, #3742fa, #2f3542);
        }

        .team-header-left {
            display: flex;
            align-items: center;
            gap: 15px; /* 아이콘과 입력창 사이 간격 */
        }

        .team-header-right {
            display: flex;
            gap: 8px; /* 버튼들 사이 간격 */
            margin-left: auto;
        }

        .team-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
        }

        /* 팀명 입력창 스타일 */
        .team-name-input {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            text-align: center;
            width: 200px;
            transition: all 0.3s ease;
        }

        .team-name-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.4);
            background: rgba(255, 255, 255, 0.3);
        }

        .team-name-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }


        .player-input {
            margin-bottom: 15px;
        }

        .player-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .code-editor {
            width: 100%;
            height: 120px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #fff;
            resize: vertical;
        }

        .code-editor:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .start-battle-btn {
            text-align: center;
            margin-top: 20px;
        }

        .btn-large {
            padding: 20px 40px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.4);
        }

        .battle-arena {
            background: #2c3e50;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            max-width: 1400px;
            margin: 0 auto;
        }

        .arena-content {
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            gap: 10px;
            align-items: start;
        }

        .arena-title {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #ecf0f1;
            grid-column: 1 / -1;
        }

        .battlefield {
            width: 900px;
            height: 600px;
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border: 3px solid #95a5a6;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
        }

        .tank {
            position: absolute;
            width: 35px;
            height: 35px;
            border-radius: 4px;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .tank-red {
            background: #e74c3c;
            color: white;
        }

        .tank-blue {
            background: #3498db;
            color: white;
        }

        .tank-name {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            pointer-events: none;
        }

        .tank-name.dead {
            color: #000;
            background: rgba(100, 100, 100, 0.8);
        }

        .bullet {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            transition: all 0.1s linear;
        }

        .bullet-red {
            background: #e74c3c;
            box-shadow: 0 0 6px #e74c3c;
        }

        .bullet-blue {
            background: #3498db;
            box-shadow: 0 0 6px #3498db;
        }

        .explosion {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ff6b6b, #feca57, transparent);
            border-radius: 50%;
            animation: explode 0.5s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-start {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }

        .btn-reset {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-pause {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-back {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(149, 165, 166, 0.3);
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #a0a0a0;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .alive-players {
            font-size: 1rem;
            color: #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
            text-align: center;
        }

        .player-alive {
            margin-bottom: 3px;
            padding: 4px;
        }

        .player-dead {
            margin-bottom: 3px;
            padding: 2px;
            color: #000;
            background: rgba(100, 100, 100, 0.3);
            border-radius: 3px;
        }

        .red-team .stat-value {
            color: #ffffff;
        }

        .blue-team .stat-value {
            color: #ffffff;
        }

        .sample-code {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-size: 11px;
            border-left: 3px solid #4ecdc4;
        }

        .sample-code pre {
            margin: 0;
            color: #a0a0a0;
        }

        /* 레드팀 피탄 이펙트 */
        .hit-effect-red {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ff4444, #ff8888, transparent);
            border-radius: 50%;
            animation: hitFlashRed 0.3s ease-out forwards;
            pointer-events: none;
            z-index: 15;
        }

        /* 블루팀 피탄 이펙트 */
        .hit-effect-blue {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #4488ff, #88aaff, transparent);
            border-radius: 50%;
            animation: hitFlashBlue 0.3s ease-out forwards;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes hitFlashRed {
            0% {
                transform: scale(0.5);
                opacity: 1;
                background: radial-gradient(circle, #ff4444, #ff8888, transparent);
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
                background: radial-gradient(circle, #ff6666, #ffaaaa, transparent);
            }
            100% {
                transform: scale(2);
                opacity: 0;
                background: radial-gradient(circle, #ff8888, #ffcccc, transparent);
            }
        }

        @keyframes hitFlashBlue {
            0% {
                transform: scale(0.5);
                opacity: 1;
                background: radial-gradient(circle, #4488ff, #88aaff, transparent);
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
                background: radial-gradient(circle, #6699ff, #aaccff, transparent);
            }
            100% {
                transform: scale(2);
                opacity: 0;
                background: radial-gradient(circle, #88aaff, #ccddff, transparent);
            }
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(0.8);
            }
            20% {
                opacity: 1;
                transform: translateY(-10px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px) scale(1);
            }
        }

        /* 데미지 텍스트도 색상 구분 */
        .damage-text-red {
            position: absolute;
            font-family: 'Arial Black', Arial, sans-serif;
            font-size: 16px;
            color: #ff4444;
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
            z-index: 16;
        }

        .damage-text-blue {
            position: absolute;
            font-family: 'Arial Black', Arial, sans-serif;
            font-size: 16px;
            color: #4488ff;
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
            z-index: 16;
        }

        /* Import/Export 버튼 스타일 */
        .team-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .btn-control {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-control:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2c3e50;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #444;
        }

        .modal-header h3 {
            margin: 0;
            color: #ecf0f1;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #bdc3c7;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
        }

        .modal-body {
            flex: 1;
            padding: 20px;
        }

        #modal-textarea {
            width: 100%;
            height: 400px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #fff;
            resize: none;
        }

        #modal-textarea:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            border-top: 1px solid #444;
        }

        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-cancel:hover {
            background: #7f8c8d;
        }

        .btn-confirm {
            background: #2ecc71;
            color: white;
        }

        .btn-confirm:hover {
            background: #27ae60;
        }

        /* 정보 버튼 스타일 */
        .btn-info {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* 탱크 정보 모달 스타일 */
        .tank-info-content {
            max-width: 900px;
            width: 90%;
        }

        .tank-info-description {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .tank-info-description p {
            margin: 8px 0;
            color: #ecf0f1;
        }

        .tank-info-description strong {
            color: #3498db;
        }

        .tank-info-description em {
            color: #95a5a6;
            font-style: italic;
        }

        /* 탱크 타입 카드 컨테이너 */
        #tank-types-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* 탱크 타입 카드 */
        .tank-type-card {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tank-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--type-color);
        }

        .tank-type-card.normal::before {
            --type-color: linear-gradient(90deg, #95a5a6, #7f8c8d);
        }

        .tank-type-card.tanker::before {
            --type-color: linear-gradient(90deg, #e67e22, #d35400);
        }

        .tank-type-card.dealer::before {
            --type-color: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .tank-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .tank-type-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .tank-type-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .tank-type-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ecf0f1;
        }

        .tank-type-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--stat-color);
        }

        .stat-item.energy {
            --stat-color: #3498db;
        }

        .stat-item.size {
            --stat-color: #9b59b6;
        }

        .stat-item.speed {
            --stat-color: #2ecc71;
        }

        .stat-item.damage {
            --stat-color: #e74c3c;
        }

        .stat-label {
            font-weight: bold;
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            color: #ecf0f1;
            font-size: 1.1rem;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            #tank-types-container {
                grid-template-columns: 1fr;
            }

            .tank-type-stats {
                grid-template-columns: 1fr;
            }

            .tank-info-content {
                width: 95%;
                margin: 20px auto;
            }
        }
        .arena-title-container {
            position: relative;
            width: 900px;
            margin: 0 auto 0px auto;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .energy-balance-bar {
            position: absolute;
            width: 100%;
            height: 50px;
            border: 2px solid #95a5a6;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            background: #2c3e50;
            z-index: 1;
        }

        .arena-title {
            position: relative;
            z-index: 2;
            font-size: 1.5rem;
            margin: 0;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            opacity: 0.5;
        }

        .energy-red {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .energy-blue {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Tech of Tank</h1>
            <p class="subtitle">6v6 Team Battle Arena - Code Your Tank AI</p>
            <div class="header-buttons">
                <button class="btn-info" onclick="showTankInfo()">📊 Tank Types Info</button>
            </div>
        </div>

        <!-- 탱크 정보 모달 -->
        <div id="tank-info-modal" class="modal" style="display: none;">
            <div class="modal-content tank-info-content">
                <div class="modal-header">
                    <h3>🚀 탱크 타입별 속성 정보</h3>
                    <button class="modal-close" onclick="closeTankInfo()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tank-info-description">
                        <p><strong>탱크 type 별 속성입니다.</strong></p>
                        <p>각 조에서 원하는 type, 배치 등 마음대로 하실 수 있습니다.</p>
                        <p><em>ex) TANKER 만 6대 or DEALER 만 6대 등</em></p>
                    </div>
                    <div id="tank-types-container">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal btn-confirm" onclick="closeTankInfo()">확인</button>
                </div>
            </div>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setup-screen">
            <div class="setup-content">
                <!-- Red Team Setup -->
                <div class="team-setup team-red">
                    <div class="team-header">
                        <div class="team-header-left">
                            <div class="team-icon">🔴</div>
                            <input type="text" class="team-name-input" id="red-team-name" placeholder="RED TEAM" maxlength="20">
                        </div>
                        <div class="team-header-right">
                            <button class="btn-control" onclick="openImport('red')">📥 Import</button>
                            <button class="btn-control" onclick="openExport('red')">📤 Export</button>
                        </div>
                    </div>

                    <div id="red-players">
                        <!-- Red team player inputs will be generated here -->
                    </div>

                    <div class="sample-code">
                        <strong>Sample Code:</strong>
                        <pre>function name() {
  return "Player Name";
}
function type() {
  return Type.NORMAL; // Type.TANKER, Type.DEALER
}
function update(tank, enemies, allies, bulletInfo) {
  if (enemies.length > 0) {
    let nearest = enemies[0];
    for (let enemy of enemies) {
      if (enemy.distance < nearest.distance) {
        nearest = enemy;
      }
    }
    const fireAngle = Math.atan2(nearest.y - tank.y, nearest.x - tank.x) * 180 / Math.PI;
    tank.fire(fireAngle);
    //move 시도 - 실패시 재호출 가능 (최대 10번)
    if(!tank.move(Math.random() * 360)) {
      tank.move(fireAngle + 180);
    }
  }
}</pre>
                    </div>
                </div>

                <!-- Blue Team Setup -->
                <div class="team-setup team-blue">
                    <div class="team-header">
                        <div class="team-header-left">
                            <div class="team-icon">🔵</div>
                            <input type="text" class="team-name-input" id="blue-team-name" placeholder="BLUE TEAM" maxlength="20">
                        </div>
                        <div class="team-header-right">
                            <button class="btn-control" onclick="openImport('blue')">📥 Import</button>
                            <button class="btn-control" onclick="openExport('blue')">📤 Export</button>
                        </div>
                    </div>

                    <div id="blue-players">
                        <!-- Blue team player inputs will be generated here -->
                    </div>

                    <div class="sample-code">
                        <strong>Sample Code:</strong>
                        <pre>function name() {
  return "Player Name";
}
function type() {
  return Type.NORMAL; // Type.TANKER, Type.DEALER
}
function update(tank, enemies, allies, bulletInfo) {
  if (enemies.length > 0) {
    let nearest = enemies[0];
    for (let enemy of enemies) {
      if (enemy.distance < nearest.distance) {
        nearest = enemy;
      }
    }
    const fireAngle = Math.atan2(nearest.y - tank.y, nearest.x - tank.x) * 180 / Math.PI;
    tank.fire(fireAngle);
    //move 시도 - 실패시 재호출 가능 (최대 10번)
    if(!tank.move(Math.random() * 360)) {
      tank.move(fireAngle + 180);
    }
  }
}</pre>
                    </div>
                </div>
            </div>

            <div class="start-battle-btn">
                <button class="btn-large" onclick="startSetup()">🚀 START BATTLE</button>
            </div>
        </div>

        <!-- Battle Screen -->
        <div class="battle-screen" id="battle-screen">
            <div class="battle-arena">

                <div class="controls">
                    <button class="btn btn-start" onclick="startBattle()">START</button>
                    <button class="btn btn-pause" onclick="pauseBattle()">PAUSE</button>
                    <button class="btn btn-reset" onclick="resetBattle()">RESET</button>
                    <button class="btn btn-back" onclick="backToSetup()">BACK TO SETUP</button>
                </div>

                <div class="arena-title-container">
                    <div class="energy-balance-bar">
                        <div class="energy-red" id="energy-red-bar"></div>
                        <div class="energy-blue" id="energy-blue-bar"></div>
                    </div>
                    <h2 class="arena-title">⚔️ BATTLE ARENA ⚔️</h2>
                </div>

                <div class="arena-content">
                    <!-- Red Team Stats -->
                    <div class="stats red-team">
                        <div class="stat-label" id="red-team-label">🔴 Red Team</div>
                        <div class="stat-value" id="red-alive">6</div>
                        <div class="stat-value" id="red-total-energy" style="font-size: 1rem; color: #4ecdc4; margin-bottom: 10px;">Energy: 0</div>
                        <div class="alive-players" id="red-team-list">
                            <!-- Red team players will be listed here -->
                        </div>
                    </div>

                    <!-- Battlefield -->
                    <div class="battlefield" id="battlefield">
                        <!-- Tanks and bullets will be rendered here -->
                    </div>

                    <!-- Blue Team Stats -->
                    <div class="stats blue-team">
                        <div class="stat-label" id="blue-team-label">🔵 Blue Team</div>
                        <div class="stat-value" id="blue-alive">6</div>
                        <div class="stat-value" id="blue-total-energy" style="font-size: 1rem; color: #4ecdc4; margin-bottom: 10px;">Energy: 0</div>
                        <div class="alive-players" id="blue-team-list">
                            <!-- Blue team players will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 탱크 타입 상수 정의
        const Type = {
            NORMAL: 0,
            TANKER: 1,
            DEALER: 2
        };
        // 타입별 설정
        const TANK_CONFIGS = {
            [Type.NORMAL]: {
                energy: 100,
                size: 35,
                speed: 5,
                damage: 5
            },
            [Type.TANKER]: {
                energy: 150,
                size: 45,
                speed: 3,
                damage: 4.5
            },
            [Type.DEALER]: {
                energy: 80,
                size: 33,
                speed: 6,
                damage: 6.5
            }
        };

        class Tank {
            constructor(id, x, y, team, playerName, tankType = Type.NORMAL) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.team = team;
                this.playerName = playerName;
                this.tankType = tankType;

                // 타입별 설정 적용
                const config = TANK_CONFIGS[tankType];
                this.angle = Math.random() * 360;
                this.health = config.energy;
                this.energy = config.energy;
                this.gunAngle = this.angle;
                this.speed = config.speed;
                this.size = config.size;
                this.damage = config.damage;

                this.alive = true;
                this.lastFire = 0;
                this.code = '';
                this.hasMoved = false;
            }

            move(direction) {
                if (!this.alive || this.hasMoved) return false;

                // 엔진에서 직접 시도 횟수 체크
                this.moveAttempts = (this.moveAttempts || 0) + 1;
                if (this.moveAttempts > 10) {
                    return true; // 10번 초과시 더 이상 이동 불가 - 이동 했다고 처리
                }

                const rad = (direction * Math.PI) / 180;
                const newX = this.x + Math.cos(rad) * this.speed;
                const newY = this.y + Math.sin(rad) * this.speed;

                // Check battlefield boundaries (accounting for tank size)
                const tankRadius = this.size / 2; // 동적 크기 적용
                if (newX - tankRadius < 0 || newX + tankRadius > 900 ||
                    newY - tankRadius < 0 || newY + tankRadius > 600) {
                    return false;
                }

                // Check collision with other tanks
                for (let tank of tanks) {
                    if (tank.id === this.id || !tank.alive) continue;

                    const distance = Math.sqrt((tank.x - newX) ** 2 + (tank.y - newY) ** 2);
                    const combinedRadius = (this.size + tank.size) / 2 + 5; // 안전 여백
                    if (distance < combinedRadius) {
                        return false;
                    }
                }

                // Movement successful
                this.hasMoved = true;
                this.angle = direction;
                this.x = newX;
                this.y = newY;
                return true;
            }

            fire(angle) {
                if (!this.alive || Date.now() - this.lastFire < 500) return false;
                if (angle === undefined || angle === null) return false;

                this.lastFire = Date.now();

                const rad = (angle * Math.PI) / 180;
                const bullet = {
                    x: this.x,
                    y: this.y,
                    vx: Math.cos(rad) * 8,
                    vy: Math.sin(rad) * 8,
                    team: this.team,
                    owner: this.id,
                    damage: this.damage,
                    ownerType: this.tankType
                };

                bullets.push(bullet);
                logMessage(`${this.playerName} (${this.id}) fired at ${Math.round(angle)}°!`, this.team);
                return true;
            }

            takeDamage(damage) {
                this.health -= damage;

                if (this.health <= 0) {
                    this.alive = false;
                    logMessage(`${this.playerName} (${this.id}) destroyed!`, 'system');
                }
            }

            resetMoveFlag() {
                this.hasMoved = false;
                this.moveAttempts = 0; // move 시도 횟수도 함께 리셋
            }
        }

        let tanks = [];
        let bullets = [];
        let gameRunning = false;
        let gameLoop;
        let playerData = [];

        function createPlayerInputs() {
            const redContainer = document.getElementById('red-players');
            const blueContainer = document.getElementById('blue-players');

            // Red team inputs
            for (let i = 1; i <= 6; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                div.innerHTML = `
                    <label class="player-label">Tank R${i} Code:</label>
                    <textarea class="code-editor" id="red-code-${i}" placeholder="function name() {
  return 'Player R${i}';
}
function type() {
  return Type.NORMAL; // Type.TANKER, Type.DEALER
}
function update(tank, enemies, allies, bulletInfo) {
  if (enemies.length > 0) {
    let nearest = enemies[0];
    for (let enemy of enemies) {
      if (enemy.distance < nearest.distance) {
        nearest = enemy;
      }
    }
    const fireAngle = Math.atan2(nearest.y - tank.y, nearest.x - tank.x) * 180 / Math.PI;
    tank.fire(fireAngle);

    //move 시도 - 실패시 재호출 가능 (최대 10번)
    if(!tank.move(Math.random() * 360)) {
      tank.move(fireAngle + 180);
    }
  }
}"></textarea>
                `;
                redContainer.appendChild(div);
            }

            // Blue team inputs
            for (let i = 1; i <= 6; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                div.innerHTML = `
                    <label class="player-label">Tank B${i} Code:</label>
                    <textarea class="code-editor" id="blue-code-${i}" placeholder="function name() {
  return 'Player B${i}';
}
function type() {
  return Type.NORMAL; // Type.TANKER, Type.DEALER
}
function update(tank, enemies, allies, bulletInfo) {
  if (enemies.length > 0) {
    let nearest = enemies[0];
    for (let enemy of enemies) {
      if (enemy.distance < nearest.distance) {
        nearest = enemy;
      }
    }
    const fireAngle = Math.atan2(nearest.y - tank.y, nearest.x - tank.x) * 180 / Math.PI;
    tank.fire(fireAngle);
    //move 시도 - 실패시 재호출 가능 (최대 10번)
    if(!tank.move(Math.random() * 360)) {
      tank.move(fireAngle + 180);
    }
  }
}"></textarea>
                `;
                blueContainer.appendChild(div);
            }
        }

        function collectPlayerData() {
            playerData = [];

            // 팀명 수집
            const redTeamName = document.getElementById('red-team-name').value.trim() || 'RED TEAM';
            const blueTeamName = document.getElementById('blue-team-name').value.trim() || 'BLUE TEAM';

            // 전역 변수에 저장
            window.redTeamName = redTeamName;
            window.blueTeamName = blueTeamName;

            // Collect Red team data
            for (let i = 1; i <= 6; i++) {
                const code = document.getElementById(`red-code-${i}`).value || getDefaultCode(i, 'red');
                let name = `Player R${i}`;
                let tankType = Type.NORMAL;

                try {
                    const func = new Function(code + '\nreturn { name: name(), type: type() };');
                    const result = func();
                    name = result.name || `Player R${i}`;
                    tankType = result.type !== undefined ? result.type : Type.NORMAL;
                } catch (error) {
                    console.error(`Error extracting data for R${i}:`, error);
                }

                playerData.push({
                    id: `R${i}`,
                    name: name,
                    code: code,
                    team: 'red',
                    type: tankType
                });
            }

            // Collect Blue team data (동일한 방식)
            for (let i = 1; i <= 6; i++) {
                const code = document.getElementById(`blue-code-${i}`).value || getDefaultCode(i, 'blue');
                let name = `Player B${i}`;
                let tankType = Type.NORMAL;

                try {
                    const func = new Function(code + '\nreturn { name: name(), type: type() };');
                    const result = func();
                    name = result.name || `Player B${i}`;
                    tankType = result.type !== undefined ? result.type : Type.NORMAL;
                } catch (error) {
                    console.error(`Error extracting data for B${i}:`, error);
                }

                playerData.push({
                    id: `B${i}`,
                    name: name,
                    code: code,
                    team: 'blue',
                    type: tankType
                });
            }
        }

        function initializeGame() {
            tanks = [];
            bullets = [];

            // Create Red Team tanks (left side) - 새로운 배치
            for (let i = 0; i < 6; i++) {
                const playerInfo = playerData[i];

                // 새로운 배치 계산: 2 1, 4 3, 6 5 순서
                let row = Math.floor(i / 2); // 0, 0, 1, 1, 2, 2
                let col = i % 2; // 0, 1, 0, 1, 0, 1

                // 열 순서를 뒤바꿈 (0->1, 1->0)
                col = 1 - col;

                const tank = new Tank(
                    playerInfo.id,
                    140 + col * 100,  // col이 뒤바뀜 (1, 0, 1, 0, 1, 0)
                    90 + row * 120,   // row는 그대로 (0, 0, 1, 1, 2, 2)
                    'red',
                    playerInfo.name,
                    playerInfo.type
                );
                tank.code = playerInfo.code;
                tanks.push(tank);
            }

            // Create Blue Team tanks (right side) - 기존과 동일
            for (let i = 0; i < 6; i++) {
                const playerInfo = playerData[i + 6];
                const tank = new Tank(
                    playerInfo.id,
                    660 + (i % 2) * 100,
                    90 + Math.floor(i / 2) * 120,
                    'blue',
                    playerInfo.name,
                    playerInfo.type
                );
                tank.code = playerInfo.code;
                tanks.push(tank);
            }
        }

        function getDefaultCode(i, team) {
            const teamPrefix = team === 'red' ? 'R' : 'B';
            return `function name() {
                      return 'Player ${teamPrefix}${i}';
                    }
                    function type() {
                      return Type.NORMAL; // Type.TANKER, Type.DEALER
                    }
                    function update(tank, enemies, allies, bulletInfo) {
                      if (enemies.length > 0) {
                        let nearest = enemies[0];
                        for (let enemy of enemies) {
                          if (enemy.distance < nearest.distance) {
                            nearest = enemy;
                          }
                        }
                        const fireAngle = Math.atan2(nearest.y - tank.y, nearest.x - tank.x) * 180 / Math.PI;
                        tank.fire(fireAngle);
                        //move 시도 - 실패시 재호출 가능 (최대 10번)
                        if(!tank.move(Math.random() * 360)) {
                          tank.move(fireAngle + 180);
                        }
                      }
                    }`;
        }

        // 피탄 이펙트 생성 함수
        function createHitEffect(x, y, damage, bulletTeam) {
            const battlefield = document.getElementById('battlefield');
            if (!battlefield) return;

            // 팀별 색상 구분
            const isRed = bulletTeam === 'red';

            // 피탄 이펙트
            const hitEffect = document.createElement('div');
            hitEffect.className = isRed ? 'hit-effect-red' : 'hit-effect-blue';
            hitEffect.style.left = (x - 20) + 'px';
            hitEffect.style.top = (y - 20) + 'px';
            hitEffect.style.zIndex = '9999'; // 인라인으로 강제 설정
            hitEffect.style.position = 'absolute';
            battlefield.appendChild(hitEffect);

            // 데미지 텍스트
            const damageText = document.createElement('div');
            damageText.className = isRed ? 'damage-text-red' : 'damage-text-blue';
            damageText.textContent = `-${damage}`;
            damageText.style.left = (x) + 'px';
            damageText.style.top = (y - 40) + 'px';
            damageText.style.zIndex = '9999'; // 인라인으로 강제 설정
            damageText.style.position = 'absolute';
            battlefield.appendChild(damageText);

            // 이펙트 제거
            setTimeout(() => {
                if (hitEffect.parentNode) {
                    hitEffect.parentNode.removeChild(hitEffect);
                }
            }, 300);

            // 데미지 텍스트 제거
            setTimeout(() => {
                if (damageText.parentNode) {
                    damageText.parentNode.removeChild(damageText);
                }
            }, 1000);
        }

        function executeTankAI(tank) {
            if (!tank.alive) return;

            tank.resetMoveFlag();

            try {
                // 깊은 복사로 완전히 분리된 데이터 생성
                const createSecureData = (obj) => {
                    const copy = JSON.parse(JSON.stringify(obj));
                    return Object.freeze(copy);
                };

                const enemies = tanks.filter(t => t.team !== tank.team && t.alive)
                    .map(t => createSecureData({
                        x: t.x,
                        y: t.y,
                        distance: Math.sqrt((t.x - tank.x) ** 2 + (t.y - tank.y) ** 2),
                        angle: (Math.atan2(t.y - tank.y, t.x - tank.x) * 180) / Math.PI,
                        health: t.health
                    }));

                const allies = tanks.filter(t => t.team === tank.team && t.alive && t.id !== tank.id)
                    .map(t => createSecureData({
                        x: t.x,
                        y: t.y,
                        distance: Math.sqrt((t.x - tank.x) ** 2 + (t.y - tank.y) ** 2),
                        health: t.health
                    }));

                const bulletInfo = bullets.filter(b => b.team !== tank.team)
                    .map(b => createSecureData({
                        x: b.x,
                        y: b.y,
                        vx: b.vx,
                        vy: b.vy,
                        distance: Math.sqrt((b.x - tank.x) ** 2 + (b.y - tank.y) ** 2)
                    }));

                // 매우 제한적인 tankAPI
                const tankAPI = Object.freeze({
                    move: Object.freeze((angle) => tank.move(angle)),
                    fire: Object.freeze((angle) => tank.fire(angle)),
                    x: tank.x,
                    y: tank.y,
                    health: tank.health,
                    energy: tank.energy,
                    type: tank.tankType,
                    size: tank.size
                });

                // 완전 격리된 실행 환경
                const secureFunc = new Function('tank', 'enemies', 'allies', 'bulletInfo',
                    `"use strict";

                    // 모든 위험한 전역 변수 차단
                    const window = undefined;
                    const document = undefined;
                    const tanks = undefined;
                    const bullets = undefined;
                    const gameRunning = undefined;
                    const logMessage = undefined;
                    const Tank = undefined;
                    const Type = { NORMAL: 0, TANKER: 1, DEALER: 2 };

                    // 안전한 console만 허용
                    const console = Object.freeze({
                        log: (...args) => {},
                        warn: (...args) => {},
                        error: (...args) => {}
                    });

                    ${tank.code}
                    update(tank, enemies, allies, bulletInfo);`
                );

                secureFunc(tankAPI, Object.freeze(enemies), Object.freeze(allies), Object.freeze(bulletInfo));

            } catch (error) {
                console.error(`Error in tank ${tank.id} AI:`, error);
                // 사용자 코드 오류 시 해당 탱크 비활성화도 고려 가능
                // tank.alive = false;
            }
        }

        function updateBullets() {
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                // Check boundaries
                if (bullet.x < 0 || bullet.x > 900 || bullet.y < 0 || bullet.y > 600) {
                    return false;
                }

                // Check tank collisions
                for (let tank of tanks) {
                    if (!tank.alive) continue;

                    const distance = Math.sqrt((tank.x - bullet.x) ** 2 + (tank.y - bullet.y) ** 2);
                    const hitRadius = tank.size / 2 + 2;

                    if (distance < hitRadius) {
                        // 일반 공격 (같은 팀은 공격하지 않음)
                        if (tank.team !== bullet.team) {
                            // 피탄 이펙트 생성 (총알이 맞은 위치에)
                            createHitEffect(bullet.x, bullet.y, bullet.damage, bullet.team);

                            tank.takeDamage(bullet.damage);
                        } else {
                            return true; // 아군은 통과
                        }

                        createExplosion(bullet.x, bullet.y);
                        return false;
                    }
                }

                return true;
            });
        }

        function createExplosion(x, y) {
            const battlefield = document.getElementById('battlefield');
            if (!battlefield) return;

            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (x - 15) + 'px';
            explosion.style.top = (y - 15) + 'px';
            battlefield.appendChild(explosion);

            setTimeout(() => {
                if (explosion.parentNode) {
                    explosion.parentNode.removeChild(explosion);
                }
            }, 500);
        }

        function updateTeamLists() {
            const redTeamList = document.getElementById('red-team-list');
            const blueTeamList = document.getElementById('blue-team-list');
            const redAliveElement = document.getElementById('red-alive');
            const blueAliveElement = document.getElementById('blue-alive');
            const redEnergyElement = document.getElementById('red-total-energy');
            const blueEnergyElement = document.getElementById('blue-total-energy');
            const redEnergyBar = document.getElementById('energy-red-bar');
            const blueEnergyBar = document.getElementById('energy-blue-bar');

            if (!redTeamList || !blueTeamList) return;

            // Get all tanks for each team
            const redTanks = tanks.filter(t => t.team === 'red');
            const blueTanks = tanks.filter(t => t.team === 'blue');

            // 에너지 계산 로직 추가
            const redTotalEnergy = redTanks.filter(t => t.alive).reduce((sum, tank) => sum + Math.max(0, tank.health), 0);
            const blueTotalEnergy = blueTanks.filter(t => t.alive).reduce((sum, tank) => sum + Math.max(0, tank.health), 0);

            // 에너지 업데이트
            if (redEnergyElement) redEnergyElement.textContent = `Energy: ${Math.round(redTotalEnergy)}`;
            if (blueEnergyElement) blueEnergyElement.textContent = `Energy: ${Math.round(blueTotalEnergy)}`;

            // Update alive count
            const redAliveCount = redTanks.filter(t => t.alive).length;
            const blueAliveCount = blueTanks.filter(t => t.alive).length;

            // 에너지 계산 후 바 업데이트 (기존 에너지 계산 코드 다음에 추가)
            if (redEnergyBar && blueEnergyBar) {
                const totalEnergy = redTotalEnergy + blueTotalEnergy;
                if (totalEnergy > 0) {
                    const redPercentage = (redTotalEnergy / totalEnergy) * 100;
                    const bluePercentage = (blueTotalEnergy / totalEnergy) * 100;

                    redEnergyBar.style.width = redPercentage + '%';
                    blueEnergyBar.style.width = bluePercentage + '%';

                    redEnergyBar.textContent = redPercentage > 15 ? Math.round(redTotalEnergy) : '';
                    blueEnergyBar.textContent = bluePercentage > 15 ? Math.round(blueTotalEnergy) : '';
                } else {
                    redEnergyBar.style.width = '50%';
                    blueEnergyBar.style.width = '50%';
                    redEnergyBar.textContent = '0';
                    blueEnergyBar.textContent = '0';
                }
            }

            if (redAliveElement) redAliveElement.textContent = redAliveCount;
            if (blueAliveElement) blueAliveElement.textContent = blueAliveCount;

            // Update Red team list
            redTeamList.innerHTML = redTanks.map(tank => {
                const className = tank.alive ? 'player-alive' : 'player-dead';
                const skull = tank.alive ? ' ('+tank.health+')' : ' 💀';
                return `<div class="${className}">${tank.playerName}${skull}</div>`;
            }).join('');

            // Update Blue team list
            blueTeamList.innerHTML = blueTanks.map(tank => {
                const className = tank.alive ? 'player-alive' : 'player-dead';
                const skull = tank.alive ? ' ('+tank.health+')' : ' 💀';
                return `<div class="${className}">${tank.playerName}${skull}</div>`;
            }).join('');
        }

        function render() {
            const battlefield = document.getElementById('battlefield');
            if (!battlefield) return;

            const existingEffects = battlefield.querySelectorAll('.hit-effect-blue, .damage-text-blue, .hit-effect-red, .damage-text-red');

            // Clear previous render
            //battlefield.innerHTML = '';
            battlefield.querySelectorAll('.tank').forEach(el => el.remove());
            battlefield.querySelectorAll('.bullet').forEach(el => el.remove());
            battlefield.querySelectorAll('.tank-name').forEach(el => el.remove());
            battlefield.querySelectorAll('.health-bar').forEach(el => el.remove());

            // 탱크를 살아있는 상태에 따라 정렬 (죽은 탱크가 먼저 렌더링됨)
            const sortedTanks = [...tanks].sort((a, b) => {
                // false(죽은 탱크)가 true(살아있는 탱크)보다 먼저 오도록
                return a.alive - b.alive;
            });

            // Render tanks (both alive and dead for names)
            sortedTanks.forEach(tank => {
                const tankElement = document.createElement('div');
                tankElement.className = `tank tank-${tank.team}`;
                tankElement.style.left = (tank.x - tank.size/2) + 'px';
                tankElement.style.top = (tank.y - tank.size/2) + 'px';
                tankElement.style.width = tank.size + 'px';
                tankElement.style.height = tank.size + 'px';
                tankElement.title = `${tank.playerName} (${Object.keys(Type)[tank.tankType]})`;

                // 타입별 이모지 추가
                let emoji = '';
                switch(tank.tankType) {
                    case Type.DEALER:
                        emoji = '⚔️';
                        break;
                    case Type.TANKER:
                        emoji = '🛡️';
                        break;
                    case Type.NORMAL:
                    default:
                        emoji = '';
                        break;
                }

                tankElement.textContent = emoji;
                tankElement.style.fontSize = Math.max(12, tank.size * 0.4) + 'px'; // 탱크 크기에 비례
                tankElement.style.display = 'flex';
                tankElement.style.alignItems = 'center';
                tankElement.style.justifyContent = 'center';
                tankElement.style.textAlign = 'center';
                tankElement.style.lineHeight = '1';

                if (tank.alive) {
                    tankElement.style.transform = `rotate(${tank.angle}deg)`;
                    tankElement.style.opacity = '1';
                    tankElement.style.zIndex = '2'; // 살아있는 탱크는 위에
                } else {
                    tankElement.style.transform = `rotate(${tank.angle}deg)`;
                    tankElement.style.opacity = '0.3';
                    tankElement.style.filter = 'grayscale(100%)';
                    tankElement.style.zIndex = '1'; // 죽은 탱크는 아래에
                }

                battlefield.appendChild(tankElement);

                // Player name above tank (fixed screen coordinates, not relative to tank)
                const nameElement = document.createElement('div');
                nameElement.className = tank.alive ? 'tank-name' : 'tank-name dead';
                nameElement.textContent = tank.playerName;
                nameElement.style.position = 'absolute';
                nameElement.style.left = (tank.x) + 'px'; // Center horizontally on tank
                nameElement.style.top = (tank.y - 50) + 'px'; // 40px above tank center
                nameElement.style.transform = 'translateX(-50%)'; // Center the text
                nameElement.style.zIndex = tank.alive ? '12' : '11'; // 이름도 같은 순서
                nameElement.style.pointerEvents = 'none';
                battlefield.appendChild(nameElement);

                // Health bar (only for alive tanks, fixed screen coordinates)
                if (tank.alive) {
                    const healthBar = document.createElement('div');
                    healthBar.className = 'health-bar';
                    healthBar.style.position = 'absolute';
                    healthBar.style.left = (tank.x) + 'px'; // Center horizontally on tank
                    healthBar.style.top = (tank.y - 30) + 'px'; // 26px above tank center
                    healthBar.style.transform = 'translateX(-50%)'; // Center the bar
                    healthBar.style.width = '70px';
                    healthBar.style.height = '8px';
                    healthBar.style.background = `linear-gradient(to right, green ${(tank.health/tank.energy*100)}%, red ${(tank.health/tank.energy*100)}%)`;
                    healthBar.style.zIndex = '5';
                    healthBar.style.pointerEvents = 'none';
                    battlefield.appendChild(healthBar);
                }
            });

            // Render bullets
            bullets.forEach(bullet => {
                const bulletElement = document.createElement('div');
                bulletElement.className = `bullet bullet-${bullet.team}`;
                bulletElement.style.left = (bullet.x - 2) + 'px';
                bulletElement.style.top = (bullet.y - 2) + 'px';
                battlefield.appendChild(bulletElement);
            });

            //existingEffects.forEach(effect => {
            //        battlefield.appendChild(effect);
            //    });

            // Update team lists
            updateTeamLists();

            // Check win condition
            const redAlive = tanks.filter(t => t.team === 'red' && t.alive);
            const blueAlive = tanks.filter(t => t.team === 'blue' && t.alive);

            if (redAlive.length === 0 && blueAlive.length > 0) {
                gameRunning = false;
                clearInterval(gameLoop);
                logMessage('🎉 BLUE TEAM WINS! 🎉', 'system');
            } else if (blueAlive.length === 0 && redAlive.length > 0) {
                gameRunning = false;
                clearInterval(gameLoop);
                logMessage('🎉 RED TEAM WINS! 🎉', 'system');
            }
        }

        function gameUpdate() {
            if (!gameRunning) return;

            // Execute AI for all tanks
            tanks.forEach(tank => {
                if (tank.alive) {
                    executeTankAI(tank);
                }
            });

            // Update bullets
            updateBullets();

            // Render
            render();
        }

        function startSetup() {
            collectPlayerData();

            // Tank Types Info 버튼 숨기기
            const headerButtons = document.querySelector('.header-buttons');
            if (headerButtons) {
                headerButtons.style.display = 'none';
            }

            // 게임 화면의 팀명 업데이트
            document.getElementById('red-team-label').textContent = `🔴 ${window.redTeamName}`;
            document.getElementById('blue-team-label').textContent = `🔵 ${window.blueTeamName}`;

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('battle-screen').style.display = 'block';
            initializeGame();
            render();
            updateTeamLists();
            console.log('Battle Arena Ready! Click START to begin!');
        }

        function backToSetup() {
            gameRunning = false;
            clearInterval(gameLoop);
            // Tank Types Info 버튼 다시 표시
            const headerButtons = document.querySelector('.header-buttons');
            if (headerButtons) {
                headerButtons.style.display = 'block';
            }
            document.getElementById('setup-screen').style.display = 'block';
            document.getElementById('battle-screen').style.display = 'none';
        }

        function startBattle() {
            if (gameRunning) return;

            gameRunning = true;
            logMessage('🚀 Battle Started!', 'system');

            gameLoop = setInterval(gameUpdate, 50);
        }

        function pauseBattle() {
            gameRunning = !gameRunning;
            if (gameRunning) {
                gameLoop = setInterval(gameUpdate, 50);
                logMessage('▶️ Battle Resumed!', 'system');
            } else {
                clearInterval(gameLoop);
                logMessage('⏸️ Battle Paused!', 'system');
            }
        }

        function resetBattle() {
            gameRunning = false;
            clearInterval(gameLoop);
            initializeGame();
            render();
            updateTeamLists();

            logMessage('🔄 Battle Reset!', 'system');
        }

        function logMessage(message, type) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', function() {
            createPlayerInputs();
        });


        // Import/Export 기능
        let currentTeam = null;
        let currentMode = null;

        function openImport(team) {
            currentTeam = team;
            currentMode = 'import';

            const modal = document.getElementById('import-export-modal');
            const title = document.getElementById('modal-title');
            const textarea = document.getElementById('modal-textarea');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            title.textContent = `${team.toUpperCase()} 팀 코드 가져오기`;
            textarea.value = '';
            textarea.placeholder = '여기에 코드를 붙여넣으세요...\n\n각 로봇의 코드는 function name()으로 구분됩니다.';
            confirmBtn.textContent = '가져오기';
            confirmBtn.onclick = importTeamCode;

            modal.style.display = 'flex';
        }

        function openExport(team) {
            currentTeam = team;
            currentMode = 'export';

            const modal = document.getElementById('import-export-modal');
            const title = document.getElementById('modal-title');
            const textarea = document.getElementById('modal-textarea');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            title.textContent = `${team.toUpperCase()} 팀 코드 내보내기`;
            textarea.value = exportTeamCode(team);
            textarea.placeholder = '';
            confirmBtn.textContent = '복사';
            confirmBtn.onclick = copyToClipboard;

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('import-export-modal').style.display = 'none';
            currentTeam = null;
            currentMode = null;
        }

        function exportTeamCode(team) {
            let exportCode = '';

            for (let i = 1; i <= 6; i++) {
                const code = document.getElementById(`${team}-code-${i}`).value || getDefaultCode(i, team);
                exportCode += code + '\n\n// ===== 다음 로봇 =====\n\n';
            }

            return exportCode.trim();
        }

        function importTeamCode() {
            const textarea = document.getElementById('modal-textarea');
            const code = textarea.value.trim();

            if (!code) {
                alert('코드를 입력해주세요.');
                return;
            }

            try {
                // function name()을 기준으로 코드 분할
                const robotCodes = splitRobotCodes(code);

                if (robotCodes.length === 0) {
                    alert('올바른 로봇 코드를 찾을 수 없습니다.\nfunction name()이 포함된 코드를 입력해주세요.');
                    return;
                }

                // 각 텍스트박스에 코드 입력
                for (let i = 0; i < Math.min(robotCodes.length, 6); i++) {
                    const textarea = document.getElementById(`${currentTeam}-code-${i + 1}`);
                    if (textarea) {
                        textarea.value = robotCodes[i].trim();
                    }
                }

                alert(`${robotCodes.length}개의 로봇 코드를 가져왔습니다.`);
                closeModal();

            } catch (error) {
                alert('코드를 처리하는 중 오류가 발생했습니다.\n올바른 형식의 코드인지 확인해주세요.');
                console.error('Import error:', error);
            }
        }

        function splitRobotCodes(code) {
            // function name()을 기준으로 분할
            const parts = code.split(/(?=function\s+name\s*\(\s*\))/);
            const robotCodes = [];

            for (let part of parts) {
                const trimmedPart = part.trim();
                if (trimmedPart && trimmedPart.includes('function name()')) {
                    // "===== 다음 로봇 =====" 같은 구분자 제거
                    const cleanCode = trimmedPart.replace(/\/\/\s*=+.*?=+/g, '').trim();
                    robotCodes.push(cleanCode);
                }
            }

            return robotCodes;
        }

        function copyToClipboard() {
            const textarea = document.getElementById('modal-textarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // 모바일 지원

            try {
                document.execCommand('copy');
                alert('클립보드에 복사되었습니다!');
            } catch (err) {
                alert('복사에 실패했습니다. 수동으로 선택해서 복사해주세요.');
            }
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });


        // 탱크 정보 표시 함수들
        function showTankInfo() {
            const modal = document.getElementById('tank-info-modal');
            const container = document.getElementById('tank-types-container');

            // 탱크 타입 정보 생성
            container.innerHTML = generateTankTypeCards();

            modal.style.display = 'flex';
        }

        function closeTankInfo() {
            document.getElementById('tank-info-modal').style.display = 'none';
        }

        function generateTankTypeCards() {
            const typeNames = {
                [Type.NORMAL]: 'NORMAL',
                [Type.TANKER]: 'TANKER',
                [Type.DEALER]: 'DEALER'
            };

            const typeIcons = {
                [Type.NORMAL]: '⚪',
                [Type.TANKER]: '🛡️',
                [Type.DEALER]: '⚔️'
            };

            const typeClasses = {
                [Type.NORMAL]: 'normal',
                [Type.TANKER]: 'tanker',
                [Type.DEALER]: 'dealer'
            };

            const typeDescriptions = {
                [Type.NORMAL]: '균형잡힌 올라운더',
                [Type.TANKER]: '높은 체력과 방어력',
                [Type.DEALER]: '빠르고 강한 공격력'
            };

            let cardsHTML = '';

            for (let typeId in TANK_CONFIGS) {
                const config = TANK_CONFIGS[typeId];
                const typeName = typeNames[typeId];
                const typeIcon = typeIcons[typeId];
                const typeClass = typeClasses[typeId];
                const description = typeDescriptions[typeId];

                cardsHTML += `
                    <div class="tank-type-card ${typeClass}">
                        <div class="tank-type-header">
                            <div class="tank-type-icon">${typeIcon}</div>
                            <div>
                                <div class="tank-type-name">${typeName}</div>
                                <div style="color: #95a5a6; font-size: 0.9rem;">${description}</div>
                            </div>
                        </div>
                        <div class="tank-type-stats">
                            <div class="stat-item energy">
                                <span class="stat-label">💙 에너지</span>
                                <span class="stat-value">${config.energy}</span>
                            </div>
                            <div class="stat-item size">
                                <span class="stat-label">📏 크기</span>
                                <span class="stat-value">${config.size}px</span>
                            </div>
                            <div class="stat-item speed">
                                <span class="stat-label">💨 속도</span>
                                <span class="stat-value">${config.speed}</span>
                            </div>
                            <div class="stat-item damage">
                                <span class="stat-label">💥 공격력</span>
                                <span class="stat-value">${config.damage}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            return cardsHTML;
        }

        // ESC 키로 탱크 정보 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeTankInfo();
            }
        });

        // 모달 외부 클릭시 닫기
        document.getElementById('tank-info-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeTankInfo();
            }
        });
    </script>

    <!-- Import/Export 모달 -->
    <div id="import-export-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">팀 코드 가져오기</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="modal-textarea" placeholder="여기에 코드를 붙여넣으세요..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeModal()">취소</button>
                <button class="btn-modal btn-confirm" id="modal-confirm-btn">완료</button>
            </div>
        </div>
    </div>
</body>
</html>
